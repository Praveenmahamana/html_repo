<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<title>CSV Dashboard â€“ ShadCN Dark Mode</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { darkMode: 'class' }
</script>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- PapaParse -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body { font-family: 'Inter', sans-serif; }
  /* Table style */
  table.dataTable {
    border-collapse: separate !important;
    border-spacing: 0;
    border-radius: 0.5rem;
    overflow: hidden;
    background-color: rgb(24 24 27); /* zinc-900 */
    color: rgb(228 228 231); /* zinc-200 */
  }
  table.dataTable thead {
    background-color: rgb(39 39 42); /* zinc-800 */
    color: rgb(161 161 170); /* zinc-400 */
  }
  table.dataTable tbody tr:hover {
    background-color: rgb(39 39 42) !important; /* zinc-800 */
  }
  table.dataTable thead .filter-input {
    background-color: rgb(24 24 27);
    border: 1px solid rgb(63 63 70);
    color: rgb(228 228 231);
    font-size: 0.75rem;
    padding: 3px;
    border-radius: 0.25rem;
    width: 100%;
  }
  /* Dark mode DataTables controls */
  .dataTables_wrapper .dataTables_filter input {
    background-color: rgb(24 24 27);
    border: 1px solid rgb(63 63 70);
    color: rgb(228 228 231);
    padding: 4px;
    border-radius: 0.25rem;
  }
  .dataTables_wrapper .dataTables_length select {
    background-color: rgb(24 24 27);
    border: 1px solid rgb(63 63 70);
    color: rgb(228 228 231);
    border-radius: 0.25rem;
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button {
    background-color: rgb(39 39 42) !important;
    border: 1px solid rgb(63 63 70) !important;
    color: rgb(228 228 231) !important;
    border-radius: 0.25rem;
    padding: 2px 6px;
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background-color: rgb(59 130 246) !important; /* blue-500 */
    color: white !important;
  }
  .dt-button {
    background-color: rgb(59 130 246) !important;
    border: none !important;
    color: white !important;
    border-radius: 0.25rem !important;
    padding: 4px 8px !important;
    font-size: 0.75rem !important;
  }
  .pill {
    display: inline-block;
    padding: 0.15rem 0.4rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
  }
</style>
</head>
<body class="dark bg-zinc-900 text-zinc-200 p-4">

<!-- File Inputs -->
<div class="bg-zinc-800 p-3 rounded-lg shadow mb-4 flex gap-4 flex-wrap">
  <label class="cursor-pointer">
    <span class="px-3 py-1 bg-blue-600 text-white rounded">KPI CSV</span>
    <input type="file" id="file1" accept=".csv" hidden>
  </label>
  <label class="cursor-pointer">
    <span class="px-3 py-1 bg-purple-600 text-white rounded">MSFVA CSV</span>
    <input type="file" id="file2" accept=".csv" hidden>
  </label>
  <label class="cursor-pointer">
    <span class="px-3 py-1 bg-green-600 text-white rounded">FlowFVA CSV</span>
    <input type="file" id="file3" accept=".csv" hidden>
  </label>
  <label class="cursor-pointer">
    <span class="px-3 py-1 bg-pink-600 text-white rounded">ConnectionsFVA CSV</span>
    <input type="file" id="file4" accept=".csv" hidden>
  </label>
</div>

<!-- Primary Table -->
<div class="bg-zinc-800 p-3 rounded-lg shadow mb-6">
  <h2 class="text-lg font-semibold mb-2">Primary Table (KPI)</h2>
  <table id="table1" class="display w-full"></table>
</div>

<!-- Secondary Tabs -->
<div class="bg-zinc-800 p-3 rounded-lg shadow">
  <div class="border-b border-zinc-700 mb-4">
    <nav class="flex gap-2" id="secondary-tabs">
      <button data-tab="ms" class="tab-btn px-3 py-1 rounded bg-blue-600 text-white">MSFVA</button>
      <button data-tab="fl" class="tab-btn px-3 py-1 rounded hover:bg-zinc-700">FlowFVA</button>
      <button data-tab="cn" class="tab-btn px-3 py-1 rounded hover:bg-zinc-700">ConnectionsFVA</button>
    </nav>
  </div>
  <div id="tab-content">
    <div id="tab-ms" class="tab-panel">
      <table id="tbl-ms" class="display w-full"></table>
    </div>
    <div id="tab-fl" class="tab-panel hidden">
      <table id="tbl-fl" class="display w-full"></table>
    </div>
    <div id="tab-cn" class="tab-panel hidden">
      <table id="tbl-cn" class="display w-full"></table>
    </div>
  </div>
</div>

<script>
let table1, msfvaData = [], flowfvaData = [], connfvaData = [];

const pillColorMap = new Map();
function pillColor(v) {
  if (!pillColorMap.has(v)) {
    const h = [...String(v)].reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) & 0x7fffffff, 0);
    const colors = ['#3b82f6', '#a855f7', '#22c55e', '#f97316', '#eab308', '#06b6d4', '#ef4444'];
    pillColorMap.set(v, colors[h % colors.length]);
  }
  return pillColorMap.get(v);
}

function buildHeader(id, titles) {
  const $t = $(`#${id}`).empty();
  const $h = $('<thead>');
  const $hr = $('<tr>');
  const $fl = $('<tr class="filters">');
  titles.forEach(t => {
    $hr.append(`<th>${t}</th>`);
    $fl.append(`<th><input class="filter-input" placeholder="ðŸ”"></th>`);
  });
  $h.append($hr).append($fl);
  $t.append($h);
}

function initTable(id, data, cols, hidden = [], page = 10) {
  if ($.fn.dataTable.isDataTable(`#${id}`)) $(`#${id}`).DataTable().destroy();
  buildHeader(id, cols.map(c => c.title));
  const table = $(`#${id}`).DataTable({
    data,
    columns: cols.map(c => ({ ...c, visible: !hidden.includes(c.data) })),
    pageLength: page,
    orderCellsTop: true,
    dom: 'Bfrtip',
    buttons: ['copyHtml5', 'excelHtml5', 'csvHtml5'],
    scrollX: true,
    initComplete() {
      const api = this.api();
      // Bind filter row inputs
      $(`#${id} thead tr.filters th input`).each(function (i) {
        $(this).on('keyup change', function () {
          if (api.column(i).search() !== this.value) {
            api.column(i).search(this.value).draw();
          }
        });
      });
    }
  });
  return table;
}

function loadFirstTable(file) {
  Papa.parse(file, {
    header: true, skipEmptyLines: true, complete(r) {
      const rows = r.data.filter(x => Object.values(x).some(v => v));
      if (!rows.length) return alert('Empty CSV');
      const hiddenCols = [
        'DOM/INT',
		'HA_Route/Leg',
		'Distance(KM/Miles)',
		'HA_Route/Leg_ORG',
		'HA_Route/Leg_DST',
		'HA_Route/Leg',
		'Route/Leg',
		'Bucket_percentile',
		'HUB',
		'%Contri_ASK_in_bucket',
		'%Contri_ASK_in_network',
        'PDD_Dept/week',
		'APM_Dept/week',
		'Abs_Dept_Diff_Pct',
		'Abs_PLF_Diff_Pct',
        'PDD_ASK(M)/week',
		'APM_ASK(M)/week',
		'PDD_Seats/week',
		'APM_Seats/week',
        'Abs_Seats_Diff_Pct',
		'HA_Leg_Cntry_Code_Pair',
		'HA_ORG_Country_Code',
		'HA_DST_Country_Code',
		'HARoute/Leg Entity'

      ];
      const cols = Object.keys(rows[0]).map(k => {
        const col = { title: k, data: k };
        if (['Route/Leg Entity', 'Route/Leg', 'HA_Route/Leg_ORG', 'HA_Route/Leg_DST'].includes(k))
          col.render = v => `<span class="pill" style="background:${pillColor(v)}20;color:${pillColor(v)}"
                               onclick="filterSecondary('${k}','${v.replace(/'/g, "\\'")}')">${v}</span>`;
        return col;
      });
      table1 = initTable('table1', rows, cols, hiddenCols, 10);
    }
  });
}

function loadSecondTable(file, type) {
  Papa.parse(file, { header: true, skipEmptyLines: true, complete(r) {
    const rows = r.data.filter(x => Object.values(x).some(v => v));
    if (type === 'MSFVA') msfvaData = rows;
    if (type === 'FlowFVA') flowfvaData = rows;
    if (type === 'ConnectionsFVA') connfvaData = rows;
  }});
}

function filterSecondary(col, val) {
  updateSecondary(msfvaData, 'tbl-ms', col, val, 'ms');
  updateSecondary(flowfvaData, 'tbl-fl', col, val, 'fl');
  updateSecondary(connfvaData, 'tbl-cn', col, val, 'cn');
}

function updateSecondary(src, tblId, col, val, type) {
  if (!src.length) return;
  const targetVal = val.trim().toUpperCase();
  let rows;

  if (type === 'ms' || type === 'cn') {
    rows = src.filter(r => {
      const concat = String(r['origin'] || '').trim().toUpperCase() +
                     String(r['destin'] || '').trim().toUpperCase();
      return concat === targetVal;
    });
    if (type === 'ms') {
      rows = rows.filter(r => {
        const od = String(r['origin'] || '') + String(r['destin'] || '');
        return !od.startsWith('**') && !od.startsWith('*Host') && !od.startsWith('*Others');
      });
    }
  } else if (type === 'fl') {
    rows = src.filter(r => String(r['leg_OD'] || '').trim().toUpperCase() === targetVal);
  } else {
    rows = [];
  }

  const cols = Object.keys(src[0] || {}).map(k => ({ title: k, data: k }));
  initTable(tblId, rows, cols, [], 10);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
    btn.classList.add('bg-blue-600', 'text-white');
    document.getElementById('tab-' + btn.dataset.tab).classList.remove('hidden');
  });
});

document.getElementById('file1').addEventListener('change', e => loadFirstTable(e.target.files[0]));
document.getElementById('file2').addEventListener('change', e => loadSecondTable(e.target.files[0], 'MSFVA'));
document.getElementById('file3').addEventListener('change', e => loadSecondTable(e.target.files[0], 'FlowFVA'));
document.getElementById('file4').addEventListener('change', e => loadSecondTable(e.target.files[0], 'ConnectionsFVA'));
</script>

</body>
</html>
