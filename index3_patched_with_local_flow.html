<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<title>KPI Dashboard</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={darkMode:'class'}</script>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- PapaParse -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body{font-family:'Inter',sans-serif;}
  table.dataTable{border-collapse:separate!important;border-spacing:0;border-radius:.5rem;overflow:hidden;background-color:#18181b;color:#e4e4e7;}
  table.dataTable thead{background-color:#27272a;color:#a1a1aa;}
  table.dataTable tbody tr:hover{background-color:#27272a!important;}
  .dataTables_wrapper .dataTables_filter input{background-color:#18181b;border:1px solid #3f3f46;color:#e4e4e7;padding:4px;border-radius:.25rem;}
  .dataTables_wrapper .dataTables_length select{background-color:#18181b;border:1px solid #3f3f46;color:#e4e4e7;border-radius:.25rem;}
  .dataTables_wrapper .dataTables_paginate .paginate_button{background-color:#27272a!important;border:1px solid #3f3f46!important;color:#e4e4e7!important;border-radius:.25rem;padding:2px 6px;}
  .dataTables_wrapper .dataTables_paginate .paginate_button.current{background-color:#3b82f6!important;color:#fff!important;}
  .dt-button{background-color:#3b82f6!important;border:none!important;color:#fff!important;border-radius:.25rem!important;padding:4px 8px!important;font-size:.75rem!important;}
  .info-tile{width:104px;height:35px;display:grid;grid-template-rows:1fr 2fr 1fr;grid-template-columns:1fr 1fr 1fr;border-radius:8px;border:1px solid rgba(255,255,255,.2);padding:4px;box-sizing:border-box;cursor:pointer;}
  .info-tile .top-left{grid-row:1;grid-column:1;font-size:.45rem;color:#94a3b8;align-self:start;justify-self:start;}
  .info-tile .top-center{grid-row:1;grid-column:2;font-size:.5rem;font-weight:bold;align-self:start;justify-self:center;}
  .info-tile .top-right{grid-row:1;grid-column:3;font-size:.45rem;color:#94a3b8;align-self:start;justify-self:end;}
  .info-tile .center{grid-row:2;grid-column:1/span 3;font-weight:600;font-size:.65rem;color:#e2e8f0;text-align:center;}
  #tertiary-tabs .info-tile{margin:0 auto;}
</style>
</head>
<body class="dark bg-zinc-900 text-zinc-600 p-4">

<!-- FILE PICKERS -->
<div class="bg-zinc-800 p-1 rounded-lg shadow mb-1 flex gap-4 flex-wrap">
  <label class="cursor-pointer"><span class="px-5 py-0.5 bg-blue-300 text-white rounded">KPI</span><input type="file" id="file1" accept=".csv" hidden></label>
  <label class="cursor-pointer"><span class="px-5 py-0.5 bg-purple-400 text-white rounded">MS</span><input type="file" id="file2" accept=".csv" hidden></label>
  <label class="cursor-pointer"><span class="px-5 py-0.5 bg-green-400 text-white rounded">FL</span><input type="file" id="file3" accept=".csv" hidden></label>
  <label class="cursor-pointer"><span class="px-5 py-0.5 bg-pink-900 text-white rounded">CNX</span><input type="file" id="file4" accept=".csv" hidden></label>
</div>

<!-- PRIMARY TABLE -->
<div class="bg-zinc-800 p-3 rounded-lg shadow mb-6">
  <table id="table1" class="display w-full"></table>
</div>

<!-- SECONDARY TABS -->
<div class="bg-zinc-800 p-3 rounded-lg shadow">
  <div class="border-b border-zinc-700 mb-4">
    <nav class="flex gap-2" id="secondary-tabs">
      <button data-tab="fl" class="tab-btn px-3 py-1 rounded bg-blue-600 text-white">FlowFVA</button>
      <button data-tab="ms" class="tab-btn px-3 py-1 rounded hover:bg-zinc-700">MSFVA</button>
      <button data-tab="cn" class="tab-btn px-3 py-1 rounded hover:bg-zinc-700">ConnectionsFVA</button>
    </nav>
  </div>
  <div id="tab-content">
    <div id="tab-fl" class="tab-panel"><table id="tbl-fl" class="display w-full"></table></div>
    <div id="tab-ms" class="tab-panel hidden"><table id="tbl-ms" class="display w-full"></table></div>
    <div id="tab-cn" class="tab-panel hidden"><table id="tbl-cn" class="display w-full"></table></div>
  </div>
</div>

<!-- TERTIARY TABS (hidden until FlowFVA OD pill clicked) -->
<div id="tertiary-tabs" class="hidden mt-4 bg-zinc-800 p-3 rounded-lg shadow">
  <div class="border-b border-zinc-700 mb-4">
    <nav class="flex gap-2" id="tertiary-nav">
      <button data-tert="fl" class="tert-btn px-3 py-1 rounded bg-blue-600 text-white">FlowFVA</button>
      <button data-tert="ms" class="tert-btn px-3 py-1 rounded hover:bg-zinc-700">MSFVA</button>
      <button data-tert="cn" class="tert-btn px-3 py-1 rounded hover:bg-zinc-700">ConnectionsFVA</button>
    </nav>
  </div>
  <div id="tertiary-content">
    <div id="tert-fl" class="tert-panel"><table id="tert-tbl-fl" class="display w-full"></table></div>
    <div id="tert-ms" class="tert-panel hidden"><table id="tert-tbl-ms" class="display w-full"></table></div>
    <div id="tert-cn" class="tert-panel hidden"><table id="tert-tbl-cn" class="display w-full"></table></div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
let table1, msfvaData=[], flowfvaData=[], connfvaData=[];
const pillColorMap=new Map();
function pillColor(v){
  if(!pillColorMap.has(v)){
    const h=[...String(v)].reduce((a,b)=>((a<<5)-a+b.charCodeAt(0))&0x7fffffff,0);
    const colors=['#3b82f6','#a855f7','#22c55e','#f97316','#eab308','#06b6d4','#ef4444'];
    pillColorMap.set(v,colors[h%colors.length]);
  }
  return pillColorMap.get(v);
}

function initTable(id,data,cols,hidden=[],page=10){
  const $tbl=$(`#${id}`);
  if($.fn.dataTable.isDataTable($tbl)) $tbl.DataTable().destroy();
  $tbl.empty();
  return $tbl.DataTable({
    data,
    columns:cols.map(c=>({...c,visible:!hidden.includes(c.data)})),
    pageLength:page,
    dom:'Bfrtip',
    buttons:['copyHtml5','excelHtml5','csvHtml5'],
    scrollX:true
  });
}

/* ---------- primary load ---------- */
function loadFirstTable(file){
  Papa.parse(file,{header:true,skipEmptyLines:true,complete(r){
    const rows=r.data.filter(x=>Object.values(x).some(v=>v));
    if(!rows.length){alert('Empty CSV');return;}

    const whitelist=[
      'Abs_Pax_Diff_check','Abs_LF_Diff_check','Abs_Flow_Diff_check'
    ];
    const hiddenCols=Object.keys(rows[0]).filter(k=>!whitelist.includes(k));

    const cols=[];

    /* Tile 1: Arrow + Entity */
    cols.push({
      title:'Info',data:null,orderable:false,
      render:(d,t,row)=>{
        const entity=row['Route/Leg Entity']||'';
        const route=row['Route/Leg']||'';
        const bucket=String(row['Bucket_percentile']||'').trim();
        const [left,...rest]=String(entity).split('_');
        const right=rest.join('_');
        const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const bg=pillColor(route);
        const bgLight=`${bg}33`;
        let arrow='‚û°Ô∏è',arrowColor='text-yellow-400';
        if(bucket.startsWith('1.')){arrow='‚¨ÜÔ∏è';arrowColor='text-green-500';}
        else if(bucket.startsWith('3.')){arrow='‚¨áÔ∏è';arrowColor='text-red-500';}
        return `<div class="info-tile" style="background:${bgLight};border-color:${bg};" onclick="filterSecondary('Route/Leg','${esc(route).replace(/'/g,"\\'")}')">
                  <div class="top-left">${esc(left)}</div><div class="top-center ${arrowColor}">${arrow}</div><div class="top-right">${esc(right)}</div>
                  <div class="center">${esc(route)}</div>
                </div>`;
      }
    });

    /* Tile 2: KPI Checks */
    cols.push({
      title:'KPI Checks',data:null,orderable:false,
      render:(d,t,row)=>{
        const allMet=['Abs_Pax_Diff_check','Abs_LF_Diff_check','Abs_Flow_Diff_check'].every(k=>String(row[k]).toUpperCase()==='KPI-MET');
        return `<div class="info-tile ${allMet?'bg-blue-600':'bg-red-600'} text-white">
                  <div class="center">${allMet?'‚úÖ ALL':'‚ùå FAIL'}</div>
                </div>`;
      }
    });

    /* Tiles 3-5: Pax / Flow / Local */
    ['Pax','Flow','Local'].forEach(label=>{
      const pddKey=`${label==='Pax'?'':'Local_'}PDD_${label==='Pax'?'Total_pax':'Pax'}/week`;
      const apmKey=`${label==='Pax'?'':'Local_'}APM_${label==='Pax'?'Total_pax':'Pax'}/week`;
      cols.push({
        title:`${label}/week`,data:null,orderable:false,
        render:(d,t,row)=>{
          const pdd=parseFloat(row[pddKey])||0;
          const apm=parseFloat(row[apmKey])||0;
          const diff=pdd?((apm-pdd)/pdd)*100:0;
          const arrow=diff>=0?'üîº':'üîΩ';
          const color=diff>=0?'text-green-500':'text-red-500';
          return `<div class="info-tile">
                    <div class="top-left text-xs">${pdd.toLocaleString()}</div>
                    <div class="top-center ${color}">${arrow}</div>
                    <div class="top-right text-xs">${apm.toLocaleString()}</div>
                    <div class="center ${color}">${diff.toFixed(1)}%</div>
                  </div>`;
        }
      });
    });

    Object.keys(rows[0]).forEach(k=>cols.push({title:k,data:k}));
    initTable('table1',rows,cols,hiddenCols,10);
  }});
}

function loadSecondTable(file,type){
  Papa.parse(file,{header:true,skipEmptyLines:true,complete(r){
    const rows=r.data.filter(x=>Object.values(x).some(v=>v));
    if(type==='MSFVA') msfvaData=rows;
    if(type==='FlowFVA') flowfvaData=rows;
    if(type==='ConnectionsFVA') connfvaData=rows;
  }});
}


/* ---------- secondary filtering ---------- */
function updateSecondary(src, tblId, col, val, type) {
  if (!src.length) {
    if (!$.fn.dataTable.isDataTable('#' + tblId))
      initTable(tblId, [], [{ title: 'No data', data: null }], [], 10);
    return;
  }

  const targetVal = String(val || '').trim().toUpperCase();
  let rows;

  /* row filtering -------------------------------------------------------- */
  if (type === 'ms' || type === 'cn') {
    rows = src.filter(r =>
      (String(r['origin'] || r['ORG'] || r['Origin'] || '').trim().toUpperCase() +
       String(r['destin'] || r['DST'] || r['Destination'] || '').trim().toUpperCase()) === targetVal
    );
    if (type === 'ms')
      rows = rows.filter(r => {
        const od = String(r['origin'] || '') + String(r['destin'] || '');
        return !od.startsWith('**') && !od.startsWith('*Host') && !od.startsWith('*Others');
      });
  } else if (type === 'fl') {
    rows = src.filter(r =>
      String(r['leg_OD'] || r['OD'] || '').trim().toUpperCase() === targetVal
    );
  } else {
    rows = [];
  }

  /* column builder ------------------------------------------------------- */
  const cols = Object.keys(src[0] || {}).map(k => {
    /* FlowFVA OD pill */
    if (type === 'fl' && (k === 'leg_OD' || k === 'OD')) {
      return {
        title: k,
        data: k,
        orderable: false,
        render: (d, t, row) => {
          const od = String(d || '').trim();
          if (!od) return '';
          const bg = pillColor(od);
          const bgLight = `${bg}33`;
          return `
            <div class="info-tile" style="background:${bgLight};border-color:${bg};"
                 onclick="openTertiary('${od.replace(/'/g, "\\'")}')">
              <div class="center">${od}</div>
            </div>`;
        }
      };
    }
    /* default column for all tables */
    return { title: k, data: k };
  });

  initTable(tblId, rows, cols, [], 10);
}

/* ---------- tertiary drill-down ---------- */
function openTertiary(od){
  document.getElementById('tertiary-tabs').classList.remove('hidden');
  updateSecondary(flowfvaData,'tert-tbl-fl','OD',od,'fl');
  updateSecondary(msfvaData,  'tert-tbl-ms','OD',od,'ms');
  updateSecondary(connfvaData,'tert-tbl-cn','OD',od,'cn');
  setTimeout(()=>{
    const hasMs=$('#tert-tbl-ms').DataTable().data().count();
    const hasFl=$('#tert-tbl-fl').DataTable().data().count();
    const hasCn=$('#tert-tbl-cn').DataTable().data().count();
    if(hasFl) document.querySelector('button[data-tert="fl"]').click();
    else if(hasMs) document.querySelector('button[data-tert="ms"]').click();
    else if(hasCn) document.querySelector('button[data-tert="cn"]').click();
  },50);
}

document.querySelectorAll('.tert-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tert-panel').forEach(p=>p.classList.add('hidden'));
    document.querySelectorAll('.tert-btn').forEach(b=>b.classList.remove('bg-blue-600','text-white'));
    btn.classList.add('bg-blue-600','text-white');
    document.getElementById('tert-'+btn.dataset.tert).classList.remove('hidden');
  });
});

/* ---------- tab switching ---------- */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('bg-blue-600','text-white'));
    btn.classList.add('bg-blue-600','text-white');
    document.getElementById('tab-'+btn.dataset.tab).classList.remove('hidden');
  });
});

/* ---------- file listeners ---------- */
document.getElementById('file1').addEventListener('change',e=>loadFirstTable(e.target.files[0]));
document.getElementById('file2').addEventListener('change',e=>loadSecondTable(e.target.files[0],'MSFVA'));
document.getElementById('file3').addEventListener('change',e=>loadSecondTable(e.target.files[0],'FlowFVA'));
document.getElementById('file4').addEventListener('change',e=>loadSecondTable(e.target.files[0],'ConnectionsFVA'));
</script>
</body>
</html>