<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<title>KPI Dashboard</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { darkMode: 'class' }
</script>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- PapaParse -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body { font-family: 'Inter', sans-serif; }

  /* Base DataTable styling */
  table.dataTable {
    border-collapse: collapse !important;
    width: 100% !important;
    background-color: rgb(24 24 27);
    color: rgb(228 228 231);
    border-radius: 0.5rem;
    overflow: hidden;
  }
  table.dataTable thead {
    background-color: rgb(39 39 42);
    color: rgb(161 161 170);
  }
  table.dataTable thead th,
  table.dataTable tbody td {
    padding: 8px 10px;
    white-space: nowrap;
  }
  table.dataTable tbody tr:hover {
    background-color: rgb(39 39 42) !important;
  }
  .dataTables_scrollHeadInner table { margin-bottom: 0 !important; }

  /* Primary table: fixed layout for perfect alignment */
  #table1.dataTable { table-layout: fixed; }

  /* Secondary + third tables: auto layout + ellipsis */
  #tbl-fl.dataTable, #tbl-ms.dataTable, #tbl-cn.dataTable, #tbl-third.dataTable {
    table-layout: auto;
    white-space: nowrap;
  }
  #tbl-fl.dataTable td, #tbl-ms.dataTable td, #tbl-cn.dataTable td, #tbl-third.dataTable td {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* DataTables UI elements in dark mode */
  .dataTables_wrapper .dataTables_filter input {
    background-color: rgb(24 24 27);
    border: 1px solid rgb(63 63 70);
    color: rgb(228 228 231);
    padding: 4px;
    border-radius: 0.25rem;
  }
  .dataTables_wrapper .dataTables_length select {
    background-color: rgb(24 24 27);
    border: 1px solid rgb(63 63 70);
    color: rgb(228 228 231);
    border-radius: 0.25rem;
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button {
    background-color: rgb(39 39 42) !important;
    border: 1px solid rgb(63 63 70) !important;
    color: rgb(228 228 231) !important;
    border-radius: 0.25rem;
    padding: 2px 6px;
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background-color: rgb(59 130 246) !important;
    color: white !important;
  }
  .dt-button {
    background-color: rgb(59 130 246) !important;
    border: none !important;
    color: white !important;
    border-radius: 0.25rem !important;
    padding: 4px 8px !important;
    font-size: 0.75rem !important;
  }

  /* Info tile styles */
  .info-tile {
    width: 104px;
    height: 35px;
    display: grid;
    grid-template-rows: 1fr 2fr 1fr;
    grid-template-columns: 1fr 1fr 1fr;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.2);
    padding: 4px;
    box-sizing: border-box;
  }
  .info-tile .top-left {
    grid-row: 1;
    grid-column: 1;
    font-size: 0.45rem;
    color: rgb(148 163 184);
    align-self: start;
    justify-self: start;
  }
  .info-tile .top-center {
    grid-row: 1;
    grid-column: 2;
    font-size: 0.5rem;
    font-weight: bold;
    align-self: start;
    justify-self: center;
  }
  .info-tile .top-right {
    grid-row: 1;
    grid-column: 3;
    font-size: 0.45rem;
    color: rgb(148 163 184);
    align-self: start;
    justify-self: end;
  }
  .info-tile .center {
    grid-row: 2;
    grid-column: 1 / span 3;
    font-weight: 600;
    font-size: 0.65rem;
    color: rgb(226 232 240);
    text-align: center;
  }
  .info-tile .bottom-row {
    grid-row: 3;
    grid-column: 1 / span 3;
  }
</style>
</head>

<body class="dark bg-zinc-900 text-zinc-600 p-4">

<div class="bg-zinc-900 p-1 rounded-lg shadow mb-1 flex gap-4 flex-wrap">
  <label class="cursor-pointer">
    <span class="px-5 py-0.5 bg-blue-300 text-white rounded">KPI</span>
    <input type="file" id="file1" accept=".csv" hidden>
  </label>
  <label class="cursor-pointer">
    <span class="px-5 py-0.5 bg-purple-400 text-white rounded">MS</span>
    <input type="file" id="file2" accept=".csv" hidden>
  </label>
  <label class="cursor-pointer">
    <span class="px-5 py-0.5 bg-green-400 text-white rounded">FL</span>
    <input type="file" id="file3" accept=".csv" hidden>
  </label>
  <label class="cursor-pointer">
    <span class="px-5 py-0.5 bg-pink-900 text-white rounded">CNX</span>
    <input type="file" id="file4" accept=".csv" hidden>
  </label>
</div>

<div class="bg-zinc-900 p-3 rounded-lg shadow mb-6">
  <table id="table1" class="display w-full"></table>
</div>

<div class="bg-zinc-900 p-3 rounded-lg shadow">
  <div class="border-b border-zinc-700 mb-4">
    <nav class="flex gap-2" id="secondary-tabs">
      <button data-tab="fl" class="tab-btn px-3 py-1 rounded bg-blue-600 text-white">FlowFVA</button>
      <button data-tab="ms" class="tab-btn px-3 py-1 rounded hover:bg-zinc-700">MSFVA</button>
      <button data-tab="cn" class="tab-btn px-3 py-1 rounded hover:bg-zinc-700">ConnectionsFVA</button>
    </nav>
  </div>
  <div id="tab-content">
    <div id="tab-fl" class="tab-panel">
      <table id="tbl-fl" class="display w-full"></table>

      <!-- Third table (appears after clicking an OD pill) -->
      <div id="third-table-container" class="mt-4 hidden">
        <h3 class="text-white mb-2">Third Table (Filtered by OD)</h3>
        <table id="tbl-third" class="display w-full"></table>
      </div>
    </div>

    <div id="tab-ms" class="tab-panel hidden">
      <table id="tbl-ms" class="display w-full"></table>
    </div>
    <div id="tab-cn" class="tab-panel hidden">
      <table id="tbl-cn" class="display w-full"></table>
    </div>
  </div>
</div>

<script>
/* ---------- globals ---------- */
let table1, msfvaData = [], flowfvaData = [], connfvaData = [];
let lastClickedOD = '';

/* ---------- helpers ---------- */
const pillColorMap = new Map();
function pillColor(v){
  if(!pillColorMap.has(v)){
    const h=[...String(v)].reduce((a,b)=>((a<<5)-a+b.charCodeAt(0))&0x7fffffff,0);
    const colors=['#3b82f6','#a855f7','#22c55e','#f97316','#eab308','#06b6d4','#ef4444'];
    pillColorMap.set(v,colors[h%colors.length]);
  }
  return pillColorMap.get(v);
}

function htmlEsc(s){
  return String(s ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

/* DataTables init wrapper */
function initTable(id, data, cols, hidden = [], page = 10) {
  const $tbl = $(`#${id}`);
  if ($.fn.dataTable.isDataTable($tbl)) $tbl.DataTable().destroy();
  $tbl.empty();

  const isPrimary = (id === 'table1');

  return $tbl.DataTable({
    data,
    columns: cols.map(c => ({ ...c, visible: !hidden.includes(c.data) })),
    pageLength: page,
    dom: 'Bfrtip',
    buttons: ['copyHtml5', 'excelHtml5', 'csvHtml5'],
    scrollX: true,
    autoWidth: !isPrimary,
    fixedHeader: isPrimary,   // noop if plugin not loaded
    drawCallback: function () { this.api().columns.adjust(); }
  });
}

/* safe number helpers */
const num = v => {
  const x = parseFloat(String(v).replace(/,/g,''));
  return isNaN(x) ? 0 : x;
};
const pct = v => {
  const x = parseFloat(String(v).toString().replace('%',''));
  return isNaN(x) ? 0 : x;
};

/* ---------- load primary CSV ---------- */
function loadFirstTable(file){
  Papa.parse(file,{header:true,skipEmptyLines:true,complete(r){
    const rows=r.data.filter(x=>Object.values(x).some(v=>v!=='' && v!=null));
    if(!rows.length){alert('Empty CSV');return;}

    const whitelist=[]; // (keep all real cols hidden by default)
    const hiddenCols=Object.keys(rows[0]).filter(k=>!whitelist.includes(k));
    const cols=[];

    /* Tile 1: Arrow + Entity */
    cols.push({
      title:'Info',data:null,orderable:false,
      render:(d,t,row)=>{
        const entity=row['Route/Leg Entity']||'';
        const route=row['Route/Leg']||'';
        const bucket=String(row['Bucket_percentile']||'').trim();
        const [left,...rest]=String(entity).split('_');
        const right=rest.join('_');
        const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const bg=pillColor(route);
        const bgLight=`${bg}33`;
        let arrow='➡️',arrowColor='text-yellow-400';
        if(bucket.startsWith('1.')){arrow='⬆️';arrowColor='text-green-500';}
        else if(bucket.startsWith('3.')){arrow='⬇️';arrowColor='text-red-500';}
        return `<div class="info-tile" style="background:${bgLight};border-color:${bg};" onclick="filterSecondary('Route/Leg','${esc(route).replace(/'/g,'\\&#39;')}')">
                  <div class="top-left">${esc(left)}</div>
                  <div class="top-center ${arrowColor}">${arrow}</div>
                  <div class="top-right">${esc(right)}</div>
                  <div class="center">${esc(route)}</div>
                </div>`;
      }
    });

    /* Tile 2: KPI Checks */
    cols.push({
      title:'KPI Checks',data:null,orderable:false,
      render:(d,t,row)=>{
        const checkIcon=v=>String(v).toUpperCase()==='KPI-MET'?'<span class="text-green-500">✅</span>':'<span class="text-red-500">❌</span>';
        const pax=checkIcon(row['Abs_Pax_Diff_check']);
        const lf=checkIcon(row['Abs_LF_Diff_check']);
        const fl=checkIcon(row['Abs_Flow_Diff_check']);
        return `<div class="info-tile" style="background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.2);">
                  <div class="bottom-row flex justify-around items-center text-[0.55rem]" style="grid-row: 1 / span 3;">
                    <div>Pax ${pax}</div><div>LF ${lf}</div><div>FL ${fl}</div>
                  </div>
                </div>`;
      }
    });

    /* Tile 3: Pax/week */
    cols.push({
      title: 'Pax/week', data: null, orderable: false,
      render: (data, type, row) => {
        const pdd = parseFloat(row['PDD_Total_pax/week']) || 0;
        const apm = parseFloat(row['APM_Total_pax/week']) || 0;
        const diffPct = pdd ? ((apm - pdd) / pdd) * 100 : 0;
        const pddDisp = (pdd).toFixed(0);
        const apmDisp = (apm).toFixed(0);
        const diffDisp = diffPct.toFixed(2);
        const arrow = diffPct >= 0 ? '🔼' : '🔽';
        const color = diffPct >= 0 ? 'text-green-500' : 'text-red-500';
        return `<div class="info-tile" style="background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.2);">
                  <div class="top-left text-xs">${pddDisp}</div>
                  <div class="top-center ${color}">${arrow}</div>
                  <div class="top-right text-xs">${apmDisp}</div>
                  <div class="center ${color}">${diffDisp}%</div>
                </div>`;
      }
    });

    /* Tile 4: Flow/week */
    cols.push({
      title:'Flow/week',data:null,orderable:false,
      render:(d,t,row)=>{
        const pdd=num(row['Flow_PDD_Pax/week']);
        const apm=num(row['Flow_APM_Pax/week']);
        const diff=pdd?((apm-pdd)/pdd)*100:0;
        const arrow=diff>=0?'🔼':'🔽';
        const color=diff>=0?'text-green-500':'text-red-500';
        return `<div class="info-tile" style="background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.2);">
                  <div class="top-left text-xs">${pdd.toLocaleString()}</div>
                  <div class="top-center ${color}">${arrow}</div>
                  <div class="top-right text-xs">${apm.toLocaleString()}</div>
                  <div class="center ${color}">${diff.toFixed(1)}%</div>
                </div>`;
      }
    });

    /* Tile 5: Local/week */
    cols.push({
      title:'Local/week',data:null,orderable:false,
      render:(d,t,row)=>{
        const pdd=num(row['Local_PDD_Pax/week']);
        const apm=num(row['Local_APM_Pax/week']);
        const diff=pdd?((apm-pdd)/pdd)*100:0;
        const arrow=diff>=0?'🔼':'🔽';
        const color=diff>=0?'text-green-500':'text-red-500';
        return `<div class="info-tile" style="background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.2);">
                  <div class="top-left text-xs">${pdd.toLocaleString()}</div>
                  <div class="top-center ${color}">${arrow}</div>
                  <div class="top-right text-xs">${apm.toLocaleString()}</div>
                  <div class="center ${color}">${diff.toFixed(1)}%</div>
                </div>`;
      }
    });

    /* Tile 6: Flow% (fix: read % directly, no extra *100) */
    cols.push({
      title:'Flow%',data:null,orderable:false,
      render:(d,t,row)=>{
        const pdd = pct(row['Flow_PDD%']);
        const apm = pct(row['Flow_APM%']);
        const signed = apm - pdd;
        const diff = Math.abs(signed);
        const arrow = signed >= 0 ? '🔼' : '🔽';
        const color = signed >= 0 ? 'text-green-500' : 'text-red-500';
        return `<div class="info-tile" style="background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.2);">
                  <div class="top-left text-xs">${pdd.toFixed(2)}%</div>
                  <div class="top-center ${color}">${arrow}</div>
                  <div class="top-right text-xs">${apm.toFixed(2)}%</div>
                  <div class="center ${color}">${diff.toFixed(2)}%</div>
                </div>`;
      }
    });

    /* Tile 7: Load Factor */
    cols.push({
      title:'Load Factor',data:null,orderable:false,
      render:(d,t,row)=>{
        const pdd = pct(row['PLF_PDD%']);  // treat as %
        const apm = pct(row['PLF_APM%']);
        const diff = apm - pdd;
        const arrow = diff >= 0 ? '🔼' : '🔽';
        const color = diff >= 0 ? 'text-green-500' : 'text-red-500';
        return `<div class="info-tile" style="background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.2);">
                  <div class="top-left text-xs">${pdd.toFixed(2)}%</div>
                  <div class="top-center ${color}">${arrow}</div>
                  <div class="top-right text-xs">${apm.toFixed(2)}%</div>
                  <div class="center ${color}">${(Math.abs(diff)).toFixed(2)}%</div>
                </div>`;
      }
    });

    /* Add real columns (hidden) so DataTables has them */
    Object.keys(rows[0]).forEach(k=>{
      cols.push({title:k,data:k});
    });

    table1 = initTable('table1', rows, cols, hiddenCols, 10);
  }});
}

/* ---------- load secondary CSVs ---------- */
function loadSecondTable(file,type){
  Papa.parse(file,{header:true,skipEmptyLines:true,complete(r){
    const rows=r.data.filter(x=>Object.values(x).some(v=>v!=='' && v!=null));
    if(type==='MSFVA') msfvaData=rows;
    if(type==='FlowFVA') flowfvaData=rows;
    if(type==='ConnectionsFVA') connfvaData=rows;
  }});
}

/* ---------- secondary filtering ---------- */
function filterSecondary(col,val){
  updateSecondary(msfvaData,'tbl-ms',col,val,'ms');
  updateSecondary(flowfvaData,'tbl-fl',col,val,'fl');
  updateSecondary(connfvaData,'tbl-cn',col,val,'cn');

  // Switch to first non-empty tab after filtering
  setTimeout(()=>{
    const hasMs=$.fn.dataTable.isDataTable('#tbl-ms') ? $('#tbl-ms').DataTable().data().count()>0 : false;
    const hasFl=$.fn.dataTable.isDataTable('#tbl-fl') ? $('#tbl-fl').DataTable().data().count()>0 : false;
    const hasCn=$.fn.dataTable.isDataTable('#tbl-cn') ? $('#tbl-cn').DataTable().data().count()>0 : false;
    if(hasMs) document.querySelector('button[data-tab="ms"]').click();
    else if(hasFl) document.querySelector('button[data-tab="fl"]').click();
    else if(hasCn) document.querySelector('button[data-tab="cn"]').click();
  },50);
}

function updateSecondary(src,tblId,col,val,type){
  if(!src.length){
    if(!$.fn.dataTable.isDataTable('#'+tblId)) initTable(tblId,[],[{title:'No data',data:null}],[],10);
    else { const dt=$('#'+tblId).DataTable(); dt.clear().draw(); }
    return;
  }

  const targetVal=String(val||'').trim().toUpperCase();
  let rows=[];

  if(type==='ms' || type==='cn'){
    rows = src.filter(r=>{
      const o = String(r['origin'] || r['ORG'] || r['Origin'] || '').trim().toUpperCase();
      const d = String(r['destin'] || r['DST'] || r['Destination'] || '').trim().toUpperCase();
      return (o + d) === targetVal || (o + '-' + d) === targetVal;
    });
    if(type==='ms'){
      rows = rows.filter(r=>{
        const od = String(r['origin']||'') + String(r['destin']||'');
        return !od.startsWith('**') && !od.startsWith('*Host') && !od.startsWith('*Others');
      });
    }
  } else if(type==='fl'){
    rows = src.filter(r=>{
      const od = String(r['leg_OD'] || r['OD'] || '').trim().toUpperCase();
      return od === targetVal;
    });
  }

  let cols;
  if(type==='fl'){
    // hide these columns in FlowFVA
    const hiddenSet = new Set(['leg_op_aln','leg_OD','leg_entity','leg_mkt_aln','od_entity'].map(s=>s.toLowerCase()));
    cols = Object.keys(src[0] || {}).map(k=>{
      const lower = k.toLowerCase();
      if(lower === 'od'){
        return {
          title: 'OD',
          data: k,
          render: (data) => {
            const val = String(data || '').trim();
            const safe = htmlEsc(val);
            const bg = pillColor(val);
            // Use data attribute to avoid quote issues
            return `<span class="px-2 py-1 rounded-full text-white"
                       style="background-color:${bg};cursor:pointer"
                       data-od="${safe}"
                       onclick="filterThirdTable(this.dataset.od)">${safe}</span>`;
          }
        };
      }
      return { title: k, data: k, visible: !hiddenSet.has(lower) };
    });
  } else {
    cols = Object.keys(src[0] || {}).map(k=>({title:k,data:k}));
  }

  initTable(tblId, rows, cols, [], 10);
}

/* ---------- third table (filtered by OD) ---------- */
function filterThirdTable(odValue){
  lastClickedOD = String(odValue || '').trim();
  const cont = document.getElementById('third-table-container');
  cont.classList.remove('hidden');

  // Filter FlowFVA rows matching clicked OD (fallback to leg_OD if that's what's present)
  const filtered = flowfvaData.filter(r => {
    const od = String(r['OD'] || r['leg_OD'] || '').trim().toUpperCase();
    return od === lastClickedOD.toUpperCase();
  });

  // Reuse same hidden set so third table also hides those fields
  const hiddenSet = new Set(['leg_op_aln','leg_OD','leg_entity','leg_mkt_aln','od_entity'].map(s=>s.toLowerCase()));
  const cols = Object.keys(flowfvaData[0] || {}).map(k => ({ title: k, data: k, visible: !hiddenSet.has(k.toLowerCase()) }));

  initTable('tbl-third', filtered, cols, [], 10);

  // Ensure we’re on the FlowFVA tab to see the third table
  document.querySelector('button[data-tab="fl"]').click();
}

/* ---------- tab switching ---------- */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('bg-blue-600','text-white'));
    btn.classList.add('bg-blue-600','text-white');
    document.getElementById('tab-'+btn.dataset.tab).classList.remove('hidden');
  });
});

/* ---------- file listeners ---------- */
document.getElementById('file1').addEventListener('change',e=>loadFirstTable(e.target.files[0]));
document.getElementById('file2').addEventListener('change',e=>loadSecondTable(e.target.files[0],'MSFVA'));
document.getElementById('file3').addEventListener('change',e=>loadSecondTable(e.target.files[0],'FlowFVA'));
document.getElementById('file4').addEventListener('change',e=>loadSecondTable(e.target.files[0],'ConnectionsFVA'));
</script>
</body>
</html>
