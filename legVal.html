<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KPI Dashboard</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { 
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          zinc: {
            950: '#09090b'
          }
        }
      }
    }
  }
</script>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- PapaParse -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

  body { 
    font-family: 'Inter', sans-serif; 
    background-color: #09090b;
  }

  /* Enhanced DataTable styling */
  table.dataTable {
    border-collapse: collapse !important;
    width: 100% !important;
    background-color: rgb(24 24 27);
    color: rgb(228 228 231);
    border-radius: 0.5rem;
    overflow: hidden;
  }
  
  table.dataTable thead {
    background-color: rgb(39 39 42);
    color: rgb(161 161 170);
  }
  
  table.dataTable thead th,
  table.dataTable tbody td {
    padding: 0.5rem 0.75rem;
    white-space: nowrap;
    font-size: 0.875rem;
  }
  
  table.dataTable tbody tr {
    transition: background-color 0.2s ease;
  }
  
  table.dataTable tbody tr:hover {
    background-color: rgb(39 39 42) !important;
  }
  
  .dataTables_scrollHeadInner table { 
    margin-bottom: 0 !important; 
  }

  /* Primary table: auto layout for flexible columns */
  #table1.dataTable { 
    table-layout: auto; 
  }

  /* Secondary + third tables: auto layout + ellipsis */
  #tbl-fl.dataTable, #tbl-ms.dataTable, #tbl-cn.dataTable, #tbl-third.dataTable, #route-flow-table.dataTable {
    table-layout: auto;
    white-space: nowrap;
  }
  
  #tbl-fl.dataTable td, #tbl-ms.dataTable td, #tbl-cn.dataTable td, #tbl-third.dataTable td, #route-flow-table.dataTable td {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* DataTables UI elements in dark mode */
  .dataTables_wrapper .dataTables_filter input {
    background-color: rgb(24 24 27);
    border: 1px solid rgb(63 63 70);
    color: rgb(228 228 231);
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
  }
  
  .dataTables_wrapper .dataTables_filter input:focus {
    outline: none;
    border-color: rgb(99 102 241);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
  }
  
  .dataTables_wrapper .dataTables_length select {
    background-color: rgb(24 24 27);
    border: 1px solid rgb(63 63 70);
    color: rgb(228 228 231);
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button {
    background-color: rgb(39 39 42) !important;
    border: 1px solid rgb(63 63 70) !important;
    color: rgb(228 228 231) !important;
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
    margin: 0 0.125rem;
    transition: all 0.2s ease;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background-color: rgb(63 63 70) !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background-color: rgb(99 102 241) !important;
    color: white !important;
    border-color: rgb(99 102 241) !important;
  }

  /* Tile styles - no bounding box */
  .tile-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    min-height: 42px;
  }
  
  .tile-container:hover {
    background-color: rgba(255, 255, 255, 0.05);
    transform: translateY(-1px);
  }
  
  .tile-section {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 0;
  }
  
  .tile-label {
    font-size: 0.6rem;
    color: rgb(148 163 184);
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-bottom: 0.125rem;
  }
  
  .tile-value {
    font-weight: 600;
    font-size: 0.75rem;
    color: rgb(226 232 240);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
  
  .tile-diff {
    font-size: 0.7rem;
    font-weight: 500;
  }
  
  .positive {
    color: rgb(74 222 128);
  }
  
  .negative {
    color: rgb(248 113 113);
  }
  
  .neutral {
    color: rgb(254 249 195);
  }

  /* Route tile specific styles - no border, transparent background */
  .route-tile {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    min-height: 42px;
    width: 140px;
    background: transparent;
  }
  
  .route-tile:hover {
    background-color: rgba(255, 255, 255, 0.05);
    transform: translateY(-1px);
  }
  
  .route-left {
    display: flex;
    flex-direction: column;
    flex: 1;
  }
  
  .route-right {
    display: flex;
    flex-direction: column;
    flex: 1;
    align-items: flex-end;
  }
  
  .bucket-indicator {
    font-size: 0.6rem;
    font-weight: 600;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .bucket-1 {
    background-color: rgba(74, 222, 128, 0.2);
    color: rgb(74 222 128);
  }
  
  .bucket-3 {
    background-color: rgba(248, 113, 113, 0.2);
    color: rgb(248 113 113);
  }
  
  .bucket-other {
    background-color: rgba(254, 249, 195, 0.2);
    color: rgb(254 249 195);
  }
  
  .entity-value {
    font-size: 0.65rem;
    color: rgb(212 212 216);
    margin-top: 0.125rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
  
  .route-value {
    font-size: 0.9rem;
    font-weight: 700;
    color: white;
    margin-top: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  /* Two-column tile styles - no border */
  .two-column-tile {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    min-height: 42px;
    width: 140px;
    background: transparent;
  }
  
  .two-column-tile:hover {
    background-color: rgba(255, 255, 255, 0.05);
    transform: translateY(-1px);
  }
  
  .values-column {
    display: flex;
    flex-direction: column;
    flex: 1;
  }
  
  .diff-column {
    display: flex;
    flex-direction: column;
    flex: 1;
    align-items: flex-end;
  }
  
  .pdd-value {
    font-size: 0.7rem;
    color: rgb(212 212 216);
  }
  
  .apm-value {
    font-size: 0.7rem;
    color: rgb(212 212 216);
    margin-top: 0.25rem;
  }
  
  .diff-value {
    font-size: 0.85rem;
    font-weight: 700;
    margin-top: 0.125rem;
  }

  /* KPI Checks tile - more compact */
  .kpi-checks-tile {
    display: flex;
    gap: 0.75rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    min-height: 42px;
    background: transparent;
  }
  
  .kpi-checks-tile:hover {
    background-color: rgba(255, 255, 255, 0.05);
    transform: translateY(-1px);
  }
  
  .kpi-check {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
  }
  
  .kpi-label {
    font-size: 0.55rem;
    color: rgb(148 163 184);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  
  .kpi-status {
    font-size: 0.65rem;
    font-weight: 600;
    margin-top: 0.125rem;
  }

  /* File upload area */
  .file-upload-area {
    transition: all 0.3s ease;
    border: 2px dashed rgb(63 63 70);
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
  }
  
  .file-upload-area:hover {
    border-color: rgb(99 102 241);
    background-color: rgba(99, 102, 241, 0.05);
  }
  
  .file-upload-area.drag-over {
    border-color: rgb(99 102 241);
    background-color: rgba(99, 102, 241, 0.1);
  }

  /* Tab styling */
  .tab-btn {
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }
  
  .tab-btn::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background-color: rgb(99 102 241);
    transition: all 0.3s ease;
    transform: translateX(-50%);
  }
  
  .tab-btn.active::after {
    width: 100%;
  }
  
  .tab-btn:hover:not(.active)::after {
    width: 70%;
  }

  /* OD pill styling */
  .od-pill {
    transition: all 0.2s ease;
    display: inline-block;
    cursor: pointer;
  }
  
  .od-pill:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  /* Drawer wrapper – pinned to the left of the KPI container */
.flow-drawer {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  display: flex;
  align-items: center;
  pointer-events: none;        /* let clicks pass through when closed */
  z-index: 10;
}

/* Invisible trigger strip */
.flow-drawer__trigger {
  width: 1.5rem;
  height: 100%;
  cursor: pointer;
  pointer-events: auto;
}

/* Actual content */
.flow-drawer__content {
  height: 100%;
  width: 220px;                /* adjust to taste */
  background: rgb(39 39 42);    /* zinc-800 */
  border-right: 1px solid rgb(63 63 70);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  padding: 0.75rem;
  overflow-y: auto;
  pointer-events: auto;
}

/* Reveal on hover */
.flow-drawer:hover .flow-drawer__content {
  transform: translateX(0);
}

/* Drawer wrapper – fixed to bottom */
.detail-fixed {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  z-index: 1000;
  pointer-events: none;
}
.detail-trigger {
  height: 6px;
  width: 100%;
  background: rgba(99,102,241,0.5);
  cursor: pointer;
  pointer-events: auto;
}
.detail-panel {
  max-height: 0;
  overflow: hidden;
  background: rgb(24 24 27);
  border-top: 1px solid rgb(63 63 70);
  transition: max-height 0.3s ease;
  pointer-events: auto;
}
.detail-fixed.open .detail-panel {
  max-height: 70vh;
}

  /* Third table breadcrumb */
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding: 0.5rem;
    background-color: rgb(39 39 42);
    border-radius: 0.375rem;
  }

  /* Host filter input */
  .host-filter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .host-filter input {
    background-color: rgb(24 24 27);
    border: 1px solid rgb(63 63 70);
    color: rgb(228 228 231);
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
    flex: 1;
    max-width: 200px;
  }
  
  .host-filter input:focus {
    outline: none;
    border-color: rgb(99 102 241);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
  }

  /* Toggle switch */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #2196F3;
  }

  input:checked + .slider:before {
    transform: translateX(26px);
  }

  .kpi-main-table {
    flex: 3;
    min-width: 0;
    overflow: auto;
  }
  
  .top10-fixed {
    position: fixed;
    top: 10%;
    right: 0;
    transform: translateY(-50%);
    z-index: 1000;
    pointer-events: none;
  }

  /* 6 px trigger strip */
  .top10-trigger {
    width: 6px;
    height: 120px;
    background: rgba(99,102,241,0.5);
    border-radius: 4px 0 0 4px;
    cursor: pointer;
    pointer-events: auto;
  }

  /* Drawer content */
  .top10-panel {
    position: absolute;
    top: 0;
    right: 0;
    width: 220px;
    max-height: 360px;
    background: rgb(39 39 42);
    border-left: 1px solid rgb(63 63 70);
    border-radius: 0.5rem 0 0 0.5rem;
    padding: 0.75rem;
    overflow-y: auto;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    pointer-events: auto;
  }

  /* when open => stay open */
  .top10-fixed.open .top10-panel {
    transform: translateX(0);
  }

  .kpi-flow-table {
    flex: 2;
    min-width: 0;
    overflow: auto;
  }

  /* Scrollable container for tables */
  .scrollable-container {
    overflow: auto;
    max-height: 450px;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .kpi-overview-container {
      flex-direction: column;
      height: auto;
    }
    
    .scrollable-container {
      max-height: none;
    }
    
    .route-tile {
      width: 120px;
    }
    
    .two-column-tile {
      width: 120px;
    }
    
    .tile-label {
      font-size: 0.5rem;
    }
    
    .tile-value {
      font-size: 0.65rem;
    }
    
    .tile-diff {
      font-size: 0.6rem;
    }
    
    .route-value {
      font-size: 0.8rem;
    }
    
    .entity-value {
      font-size: 0.55rem;
    }
    
    .pdd-value,
    .apm-value {
      font-size: 0.6rem;
    }
    
    .diff-value {
      font-size: 0.75rem;
    }
    
    .kpi-label {
      font-size: 0.5rem;
    }
    
    .kpi-status {
      font-size: 0.6rem;
    }
    
    table.dataTable thead th,
    table.dataTable tbody td {
      padding: 0.375rem 0.5rem;
      font-size: 0.75rem;
    }
    
    .tab-btn {
      padding: 0.5rem;
      font-size: 0.875rem;
    }
  }
</style>
</head>

<body class="dark bg-zinc-950 text-zinc-300 min-h-screen p-4 md:p-6">

<!-- File Upload Section -->
<!-- ========== COLLAPSIBLE DATA SOURCES ========== -->
<style>
  /* Drawer wrapper – invisible until hover */
  .csv-drawer {
    position: relative;
    margin-bottom: 1.5rem;          /* keep spacing when closed */
  }

  .csv-drawer__trigger {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #18181b;            /* zinc-900 */
    border: 1px solid #3f3f46;      /* zinc-700 */
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: #e4e4e7;                 /* zinc-200 */
    cursor: pointer;
    transition: background 0.2s;
  }
  .csv-drawer__trigger:hover {
    background: #27272a;            /* zinc-800 */
  }

  /* Actual upload area – slides down on hover */
  .csv-drawer__content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .csv-drawer:hover .csv-drawer__content,
  .csv-drawer__content:hover {
    max-height: 500px;              /* enough to show the grid */
  }

  /* restyle the grid inside so it looks like the old card */
  .csv-drawer__card {
    margin-top: 0.5rem;
    background: #18181b;
    border-radius: 0.5rem;
    padding: 1rem;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,.4);
  }
</style>

<div class="csv-drawer">
  <!-- floating trigger -->
  <div class="csv-drawer__trigger">
    <svg class="w-2 h-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
    </svg>
    <span></span>
  </div>

  <!-- collapsible content -->
  <div class="csv-drawer__content">
    <div class="csv-drawer__card">
      <h2 class="text-lg font-semibold text-white mb-3">Data Sources</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <!-- KPI Data -->
        <div class="file-upload-area" id="upload-kpi">
          <div class="flex flex-col items-center">
            <svg class="w-6 h-6 text-blue-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <span class="text-xs font-medium text-white">KPI Data</span>
            <span class="text-[0.6rem] text-zinc-400 mt-1" id="file1-status">No file</span>
          </div>
          <input type="file" id="file1" accept=".csv" class="hidden">
        </div>

        <!-- MSFVA -->
        <div class="file-upload-area" id="upload-ms">
          <div class="flex flex-col items-center">
            <svg class="w-6 h-6 text-purple-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <span class="text-xs font-medium text-white">MSFVA</span>
            <span class="text-[0.6rem] text-zinc-400 mt-1" id="file2-status">No file</span>
          </div>
          <input type="file" id="file2" accept=".csv" class="hidden">
        </div>

        <!-- FlowFVA -->
        <div class="file-upload-area" id="upload-fl">
          <div class="flex flex-col items-center">
            <svg class="w-6 h-6 text-green-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
            <span class="text-xs font-medium text-white">FlowFVA</span>
            <span class="text-[0.6rem] text-zinc-400 mt-1" id="file3-status">No file</span>
          </div>
          <input type="file" id="file3" accept=".csv" class="hidden">
        </div>

        <!-- ConnectionsFVA -->
        <div class="file-upload-area" id="upload-cn">
          <div class="flex flex-col items-center">
            <svg class="w-6 h-6 text-pink-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="text-xs font-medium text-white">CNXFVA</span>
            <span class="text-[0.6rem] text-zinc-400 mt-1" id="file4-status">No file</span>
          </div>
          <input type="file" id="file4" accept=".csv" class="hidden">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Re-attach the same click / drop handlers to the new upload areas */
['upload-kpi','upload-ms','upload-fl','upload-cn'].forEach(id=>{
  const area = document.getElementById(id);
  const file  = document.getElementById(id.replace('upload-','file'));
  area.addEventListener('click',()=>file.click());
  ['dragenter','dragover'].forEach(e=>area.addEventListener(e,ev=>{ev.preventDefault();area.classList.add('drag-over');}));
  ['dragleave','drop'].forEach(e=>area.addEventListener(e,ev=>{ev.preventDefault();area.classList.remove('drag-over');}));
  area.addEventListener('drop',ev=>{
    const files=ev.dataTransfer.files;
    if(files.length){file.files=files;file.dispatchEvent(new Event('change',{bubbles:true}));}
  });
});
</script>
<!-- ========== /COLLAPSIBLE DATA SOURCES ========== -->

<!-- Primary Table -->
<div class="bg-zinc-900 rounded-xl shadow-lg p-4 mb-6">

  <!-- scrollable container -->
  <div class="overflow-x-auto">
    <table id="table1" class="display w-full"></table>
  </div>

  <!-- Top 10 drawer (hidden until hover) -->
	<div class="top10-fixed" id="top10-fixed">
	  <div id="top10-trigger" class="top10-trigger" title="Show top-10 (F)"></div>
	  <div class="top10-panel">
		<div class="flex justify-between items-center mb-2">
		  <h3 class="text-sm font-medium text-white">Top 10 Flow Markets</h3>
		  <button id="top10-close" class="text-xs text-zinc-400 hover:text-white">Hide</button>
		</div>
		<div id="top-od-pills" class="flex flex-col gap-2"></div>
	  </div>
	</div>
</div>


<!-- Secondary Tables Section -->
<div class="detail-fixed" id="detail-fixed">
  <div id="detail-trigger" class="detail-trigger" title="Show detailed analysis (D)"></div>
  <div class="detail-panel">
    <div class="bg-zinc-900 rounded-t-xl shadow-lg p-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-white">Detailed Analysis</h2>
        <button id="detail-close" class="text-xs text-zinc-400 hover:text-white">Hide</button>
      </div>
			  
			  <!-- Tab Navigation -->
			  <div class="border-b border-zinc-700 mb-4">
				<nav class="flex flex-wrap gap-1" id="secondary-tabs">
				  <button data-tab="fl" class="tab-btn px-4 py-2 rounded-t-lg text-sm font-medium">FlowFVA</button>
				  <button data-tab="ms" class="tab-btn px-4 py-2 rounded-t-lg text-sm font-medium">MSFVA</button>
				  <button data-tab="cn" class="tab-btn px-4 py-2 rounded-t-lg text-sm font-medium">ConnectionsFVA</button>
				</nav>
			  </div>
			  
			  <!-- Tab Content -->
			  <div id="tab-content">
				<div id="tab-fl" class="tab-panel">
				  <!-- Host filter for FlowFVA -->
				  <div class="host-filter">
					<label for="host-filter-input" class="text-sm text-white">Host:</label>
					<input type="text" id="host-filter-input" placeholder="Enter host value" class="text-sm">
					<button id="apply-host-filter" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Apply</button>
				  </div>
				  <div class="overflow-x-auto">
					<table id="tbl-fl" class="display w-full"></table>
				  </div>
				</div>

				<div id="tab-ms" class="tab-panel hidden">
				  <div class="overflow-x-auto">
					<table id="tbl-ms" class="display w-full"></table>
				  </div>
				</div>
				
				<div id="tab-cn" class="tab-panel hidden">
				  <div class="overflow-x-auto">
					<table id="tbl-cn" class="display w-full"></table>
				  </div>
				</div>
			  </div>
			</div>

    </div>
    </div>
  </div>
</div>

<script>
/* ---------- globals ---------- */
let table1, msfvaData = [], flowfvaData = [], connfvaData = [];
let lastClickedOD = '';
let currentHostFilter = '';
let selectedRoute = '';
let showOnlyFlows = false;
let filteredMSFVAData = [];
let filteredConnFVAData = [];
let filteredFlowFVAData = [];

/* ---------- helpers ---------- */
const pillColorMap = new Map();
function pillColor(v){
  if(!pillColorMap.has(v)){
    const h=[...String(v)].reduce((a,b)=>((a<<5)-a+b.charCodeAt(0))&0x7fffffff,0);
    const colors=['#3b82f6','#a855f7','#22c55e','#f97316','#eab308','#06b6d4','#ef4444'];
    pillColorMap.set(v,colors[h%colors.length]);
  }
  return pillColorMap.get(v);
}

// Top 10 drawer toggle
const top10TriggerEl = document.getElementById('top10-trigger');
if (top10TriggerEl) {
  top10TriggerEl.addEventListener('click', () => {
    document.getElementById('top10-fixed').classList.toggle('open');
  });
}

const top10CloseEl = document.getElementById('top10-close');
if (top10CloseEl) {
  top10CloseEl.addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('top10-fixed').classList.remove('open');
  });
}

// Detail drawer toggle
const detailTriggerEl = document.getElementById('detail-trigger');
if (detailTriggerEl) {
  detailTriggerEl.addEventListener('click', () => {
    document.getElementById('detail-fixed').classList.toggle('open');
  });
}

const detailCloseEl = document.getElementById('detail-close');
if (detailCloseEl) {
  detailCloseEl.addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('detail-fixed').classList.remove('open');
  });
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.key === 'f' || e.key === 'F') {
    document.getElementById('top10-fixed').classList.toggle('open');
  }
  if (e.key === 'd' || e.key === 'D') {
    document.getElementById('detail-fixed').classList.toggle('open');
  }
});


function htmlEsc(s){
  return String(s ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

/* DataTables init wrapper */
function initTable(id, data, cols, hidden = [], page = 10, hideSearch = false) {
  const $tbl = $(`#${id}`);
  if ($.fn.dataTable.isDataTable($tbl)) $tbl.DataTable().destroy();
  $tbl.empty();

  const isPrimary = (id === 'table1');

  return $tbl.DataTable({
    data,
    columns: cols.map(c => ({ ...c, visible: !hidden.includes(c.data) })),
    pageLength: page,
    dom: hideSearch ? 'frtip' : 'rtip',
    scrollX: true,
    autoWidth: true,
    fixedHeader: isPrimary,
    drawCallback: function () { this.api().columns.adjust(); }
  });
}

/* safe number helpers */
const num = v => {
  const x = parseFloat(String(v).replace(/,/g,''));
  return isNaN(x) ? 0 : x;
};
const pct = v => {
  const x = parseFloat(String(v).toString().replace('%',''));
  return isNaN(x) ? 0 : x;
};

/* ---------- load primary CSV ---------- */
function loadFirstTable(file){
  Papa.parse(file,{header:true,skipEmptyLines:true,complete(r){
    const rows=r.data.filter(x=>Object.values(x).some(v=>v!=='' && v!=null));
    if(!rows.length){alert('Empty CSV');return;}

    const whitelist=[]; // (keep all real cols hidden by default)
    const hiddenCols=Object.keys(rows[0]).filter(k=>!whitelist.includes(k));
    const cols=[];

    /* Tile 1: Route Info (wider, 2-column layout, no border, transparent background) */
    cols.push({
      title:'Route',data:null,orderable:false,
      render:(d,t,row)=>{
        const entity=row['Route/Leg Entity']||'';
        const route=row['Route/Leg']||'';
        const bucket=String(row['Bucket_percentile']||'').trim();
        const [left,...rest]=String(entity).split('_');
        const right=rest.join('_');
        const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        
        // Determine bucket class
        let bucketClass = 'bucket-other';
        if(bucket.startsWith('1.')) bucketClass = 'bucket-1';
        else if(bucket.startsWith('3.')) bucketClass = 'bucket-3';
        
	return `<div class="route-tile" onclick="onKPITileClick('${esc(route)}')">
			  <div class="route-left">
				<div class="bucket-indicator ${bucketClass}">${esc(bucket)}</div>
				<div class="entity-value">${esc(left)}_${esc(right)}</div>
			  </div>
			  <div class="route-right">
				<div class="route-value">${esc(route)}</div>
			  </div>
			</div>`;
      }
    });

    /* Tile 2: KPI Checks (no border, compact) */
    cols.push({
      title:'KPI Checks',data:null,orderable:false,
      render:(d,t,row)=>{
        const checkStatus=v=>String(v).toUpperCase()==='KPI-MET'?'Pass':'Fail';
        const paxStatus=checkStatus(row['Abs_Pax_Diff_check']);
        const lfStatus=checkStatus(row['Abs_LF_Diff_check']);
        const flStatus=checkStatus(row['Abs_Flow_Diff_check']);
        
        const paxClass = paxStatus === 'Pass' ? 'positive' : 'negative';
        const lfClass = lfStatus === 'Pass' ? 'positive' : 'negative';
        const flClass = flStatus === 'Pass' ? 'positive' : 'negative';
        
        return `<div class="kpi-checks-tile">
                  <div class="kpi-check">
                    <div class="kpi-label">Pax</div>
                    <div class="kpi-status ${paxClass}">${paxStatus}</div>
                  </div>
                  <div class="kpi-check">
                    <div class="kpi-label">LF</div>
                    <div class="kpi-status ${lfClass}">${lfStatus}</div>
                  </div>
                  <div class="kpi-check">
                    <div class="kpi-label">FL</div>
                    <div class="kpi-status ${flClass}">${flStatus}</div>
                  </div>
                </div>`;
      }
    });

    /* Tile 3: Pax/week (2-column layout, no border, no labels) */
    cols.push({
      title: 'Pax/week', data: null, orderable: false,
      render: (data, type, row) => {
        const pdd = parseFloat(row['PDD_Total_pax/week']) || 0;
        const apm = parseFloat(row['APM_Total_pax/week']) || 0;
        const diffPct = pdd ? ((apm - pdd) / pdd) * 100 : 0;
        const pddDisp = (pdd).toFixed(0);
        const apmDisp = (apm).toFixed(0);
        const diffDisp = diffPct.toFixed(2);
        
        const diffClass = diffPct >= 0 ? 'positive' : 'negative';
        
        return `<div class="two-column-tile">
                  <div class="values-column">
                    <div class="pdd-value">${pddDisp}</div>
                    <div class="apm-value">${apmDisp}</div>
                  </div>
                  <div class="diff-column">
                    <div class="diff-value ${diffClass}">${diffDisp}%</div>
                  </div>
                </div>`;
      }
    });

    /* Tile 4: Flow/week (2-column layout, no border, no labels) */
    cols.push({
      title:'Flow/week',data:null,orderable:false,
      render:(d,t,row)=>{
        const pdd=num(row['Flow_PDD_Pax/week']);
        const apm=num(row['Flow_APM_Pax/week']);
        const diff=pdd?((apm-pdd)/pdd)*100:0;
        const diffClass = diff >= 0 ? 'positive' : 'negative';
        
        return `<div class="two-column-tile">
                  <div class="values-column">
                    <div class="pdd-value">${pdd.toLocaleString()}</div>
                    <div class="apm-value">${apm.toLocaleString()}</div>
                  </div>
                  <div class="diff-column">
                    <div class="diff-value ${diffClass}">${diff.toFixed(1)}%</div>
                  </div>
                </div>`;
      }
    });

    /* Tile 5: Local/week (2-column layout, no border, no labels) */
    cols.push({
      title:'Local/week',data:null,orderable:false,
      render:(d,t,row)=>{
        const pdd=num(row['Local_PDD_Pax/week']);
        const apm=num(row['Local_APM_Pax/week']);
        const diff=pdd?((apm-pdd)/pdd)*100:0;
        const diffClass = diff >= 0 ? 'positive' : 'negative';
        
        return `<div class="two-column-tile">
                  <div class="values-column">
                    <div class="pdd-value">${pdd.toLocaleString()}</div>
                    <div class="apm-value">${apm.toLocaleString()}</div>
                  </div>
                  <div class="diff-column">
                    <div class="diff-value ${diffClass}">${diff.toFixed(1)}%</div>
                  </div>
                </div>`;
      }
    });

    /* Tile 6: Flow% (2-column layout, no border, no labels) */
    cols.push({
      title:'Flow%',data:null,orderable:false,
      render:(d,t,row)=>{
        const pdd = pct(row['Flow_PDD%']*100);
        const apm = pct(row['Flow_APM%']*100);
        const signed = apm - pdd;
        const diff = Math.abs(signed);
        const diffClass = signed >= 0 ? 'positive' : 'negative';
        
        return `<div class="two-column-tile">
                  <div class="values-column">
                    <div class="pdd-value">${pdd.toFixed(2)}%</div>
                    <div class="apm-value">${apm.toFixed(2)}%</div>
                  </div>
                  <div class="diff-column">
                    <div class="diff-value ${diffClass}">${diff.toFixed(2)}%</div>
                  </div>
                </div>`;
      }
    });

    /* Tile 7: Load Factor (2-column layout, no border, no labels) */
    cols.push({
      title:'Load Factor',data:null,orderable:false,
      render:(d,t,row)=>{
        const pdd = pct(row['PLF_PDD%']*100);  // treat as %
        const apm = pct(row['PLF_APM%']*100);
        const diff = apm - pdd;
        const diffClass = diff >= 0 ? 'positive' : 'negative';
        
        return `<div class="two-column-tile">
                  <div class="values-column">
                    <div class="pdd-value">${pdd.toFixed(2)}%</div>
                    <div class="apm-value">${apm.toFixed(2)}%</div>
                  </div>
                  <div class="diff-column">
                    <div class="diff-value ${diffClass}">${(Math.abs(diff)).toFixed(2)}%</div>
                  </div>
                </div>`;
      }
    });

    /* Add real columns (hidden) so DataTables has them */
    Object.keys(rows[0]).forEach(k=>{
      cols.push({title:k,data:k});
    });

    table1 = initTable('table1', rows, cols, hiddenCols, rows.length, true); // show all
    
    // Update file status
    document.getElementById('file1-status').textContent = file.name;
  }});
}

/* ---------- select route and filter all tables ---------- */
function selectRouteAndFilter(route) {
  selectedRoute = route;
  lastClickedOD = '';

  // Filter FlowFVA
  filteredFlowFVAData = flowfvaData.filter(r =>
    String(r['leg_OD'] || '').trim().toUpperCase() === route.toUpperCase()
  );

  // Filter MSFVA
  filteredMSFVAData = msfvaData.filter(r => {
    const legOD = String(r['origin'] + '-' + r['destin']).trim().toUpperCase();
    return legOD === route.toUpperCase();
  });

  // Filter ConnectionsFVA
  filteredConnFVAData = connfvaData.filter(r => {
    const legOD = String(r['origin'] + '-' + r['destin']).trim().toUpperCase();
    return legOD === route.toUpperCase();
  });

  updateFlowFVATable();
  updateMSFVATable();
  updateConnectionsFVATable();
  updateTopODsContainer();
}

function onKPITileClick(route) {
  selectedRoute = route; // store current route
  lastClickedOD = '';    // not filtering by OD yet

  // Filter FlowFVA
  filteredFlowFVAData = flowfvaData.filter(r =>
    String(r['leg_OD'] || '').trim().toUpperCase() === route.toUpperCase()
  );

  // Filter MSFVA
  filteredMSFVAData = msfvaData.filter(r => {
    const legOD = String(r['leg_OD'] || r['OD'] || (r.origin + r.destin) || '').trim().toUpperCase();
    return legOD === route.toUpperCase();
  });

  // Filter ConnectionsFVA
  filteredConnFVAData = connfvaData.filter(r => {
    const legOD = String(r['leg_OD'] || r['OD'] || (r.origin + r.destin) || '').trim().toUpperCase();
    return legOD === route.toUpperCase();
  });

  // Update tables
  updateFlowFVATable();
  updateMSFVATable();
  updateConnectionsFVATable();

  // Update top ODs with new sorting rule
  updateTopODsContainer();
}


/* ---------- route flow table function removed as per request ---------- */

/* ---------- filter all tables by OD ---------- */
function filterAllTablesByOD(odValue) {
  lastClickedOD = String(odValue || '').trim();
  selectedRoute = '';               // we are NOT filtering by route now

  // 2a. FlowFVA → filter by OD column
  filteredFlowFVAData = flowfvaData.filter(r =>
    String(r['OD'] || '').trim().toUpperCase() === lastClickedOD.toUpperCase()
  );
  updateFlowFVATable();

  // 2b. MSFVA & ConnectionsFVA → combine origin+destin
  filteredMSFVAData = msfvaData.filter(r => {
    const o = String(r.origin || r.ORG || r.Origin || '').trim().toUpperCase();
    const d = String(r.destin || r.DST || r.Destination || '').trim().toUpperCase();
    return (o + d) === lastClickedOD.toUpperCase();
  });
  updateMSFVATable();

  filteredConnFVAData = connfvaData.filter(r => {
    const o = String(r.origin || r.ORG || r.Origin || '').trim().toUpperCase();
    const d = String(r.destin || r.DST || r.Destination || '').trim().toUpperCase();
    return (o + d) === lastClickedOD.toUpperCase();
  });
  updateConnectionsFVATable();

  // switch to the first tab that has data
  setTimeout(() => {
    if (filteredFlowFVAData.length)  document.querySelector('button[data-tab="fl"]').click();
    else if (filteredMSFVAData.length) document.querySelector('button[data-tab="ms"]').click();
    else if (filteredConnFVAData.length) document.querySelector('button[data-tab="cn"]').click();
  }, 50);
}

/* ---------- update top ODs container ---------- */
function updateTopODsContainer() {
  const topODContainer = document.getElementById('top-od-pills');
  topODContainer.innerHTML = '';
  
  if (!flowfvaData.length) {
    topODContainer.innerHTML = '<span class="text-zinc-400 text-xs">No data available</span>';
    return;
  }

  // Filter FlowFVA by selected route if available
  let filteredData = flowfvaData;
  if (selectedRoute) {
    filteredData = flowfvaData.filter(row =>
      String(row['leg_OD'] || '').trim() === selectedRoute
    );
  }

  // Filter where local = 0
  const localZeroRows = filteredData.filter(row => num(row['local']) === 0);

  if (!localZeroRows.length) {
    topODContainer.innerHTML = '<span class="text-zinc-400 text-xs">No ODs with local=0 found</span>';
    return;
  }

  // --- Determine sort order from KPI table data ---
  let sortAsc = false; // default: descending
  if (selectedRoute && table1) {
    const kpiRow = table1.data().toArray().find(r =>
      String(r['Route/Leg'] || '').trim() === selectedRoute
    );
    if (kpiRow) {
      const pdd = num(kpiRow['Flow_PDD_Pax/week']);
      const apm = num(kpiRow['Flow_APM_Pax/week']);
      sortAsc = pdd > apm; // if PDD > APM → ascending sort
    }
  }

  // Sort by flowtraf_diff according to direction
  localZeroRows.sort((a, b) => {
    const diffA = num(a['flowtraf_diff'] || 0);
    const diffB = num(b['flowtraf_diff'] || 0);
    return sortAsc ? diffA - diffB : diffB - diffA;
  });

  // Take top 10
  const topRows = localZeroRows.slice(0, 10);

  // Create pills
  topRows.forEach(row => {
    const od = String(row['OD'] || '').trim();
    if (!od) return;
    const safe = htmlEsc(od);
    const bg = pillColor(od);
    const diffValue = num(row['flowtraf_diff'] || 0).toFixed(2);

    const pill = document.createElement('div');
    pill.className = 'od-pill px-3 py-1.5 rounded-full text-white text-xs font-medium flex items-center gap-2';
    pill.style.backgroundColor = bg;
    pill.innerHTML = `
      <span>${safe}</span>
      <span class="text-white/70 text-[0.65rem]">${diffValue}</span>
    `;
    pill.onclick = () => filterAllTablesByOD(safe);

    topODContainer.appendChild(pill);
  });
}


/* ---------- load secondary CSVs ---------- */
function loadSecondTable(file,type){
  Papa.parse(file,{header:true,skipEmptyLines:true,complete(r){
    const rows=r.data.filter(x=>Object.values(x).some(v=>v!=='' && v!=null));
    if(type==='MSFVA') msfvaData=rows;
    if(type==='FlowFVA') flowfvaData=rows;
    if(type==='ConnectionsFVA') connfvaData=rows;
    
    // Update file status
    const statusId = type === 'MSFVA' ? 'file2-status' : 
                    type === 'FlowFVA' ? 'file3-status' : 'file4-status';
    document.getElementById(statusId).textContent = file.name;
    
    // If this is FlowFVA and we're on the FlowFVA tab, update the table
    if(type==='FlowFVA' && document.querySelector('button[data-tab="fl"]').classList.contains('active')) {
      updateFlowFVATable();
    }
    
    // If this is ConnectionsFVA and we're on the ConnectionsFVA tab, update the table
    if(type==='ConnectionsFVA' && document.querySelector('button[data-tab="cn"]').classList.contains('active')) {
      updateConnectionsFVATable();
    }
    
    // If this is MSFVA and we're on the MSFVA tab, update the table
    if(type==='MSFVA' && document.querySelector('button[data-tab="ms"]').classList.contains('active')) {
      updateMSFVATable();
    }
    
    // If this is FlowFVA and we have a selected route, update the top ODs container
    if(type==='FlowFVA' && selectedRoute) {
      updateTopODsContainer();
    }
    
    // Update the top ODs container when FlowFVA data is loaded
    if(type==='FlowFVA') {
      updateTopODsContainer();
    }
  }});
}

/* ---------- update FlowFVA table with host filter ---------- */
function updateFlowFVATable() {
  let dataToUse = filteredFlowFVAData.length > 0 ? filteredFlowFVAData : [];
  
  if(!dataToUse.length) {
    if(!$.fn.dataTable.isDataTable('#tbl-fl')) initTable('tbl-fl',[],[{title:'No data',data:null}],[],10);
    else { const dt=$('#tbl-fl').DataTable(); dt.clear().draw(); }
    return;
  }

  let filteredRows = dataToUse;
  
  // Apply host filter if set
  if(currentHostFilter) {
    filteredRows = dataToUse.filter(row => {
      const opAln = String(row['leg_op_aln'] || '').trim();
      const mktAln = String(row['leg_mkt_aln'] || '').trim();
      return opAln === currentHostFilter && mktAln === currentHostFilter;
    });
  }

  // Columns to hide
  const columnsToHide = new Set([
    'tot_pm_demand', 'tot_pm_traffic', 'tot_actual_traffic', 
    'total_actual_cap', 'histleg_vs_pdd_err_pct', 'only_in_hist'
  ].map(s => s.toLowerCase()));

  // Create columns
  const cols = Object.keys(dataToUse[0] || {}).map(k => {
    const lower = k.toLowerCase();
    if(lower === 'od'){
      return {
        title: 'OD',
        data: k,
        render: (data) => {
          const val = String(data || '').trim();
          const safe = htmlEsc(val);
          const bg = pillColor(val);
          return `<span class="od-pill px-2 py-1 rounded-full text-white text-xs font-medium"
                     style="background-color:${bg}"
                     onclick="filterAllTablesByOD('${safe}')">${safe}</span>`;
        }
      };
    }
    return { 
      title: k, 
      data: k, 
      visible: !columnsToHide.has(lower) 
    };
  });

  initTable('tbl-fl', filteredRows, cols, [], 10);
}

/* ---------- update ConnectionsFVA table ---------- */
function updateConnectionsFVATable() {
  let dataToUse = filteredConnFVAData.length > 0 ? filteredConnFVAData : [];
  
  if(!dataToUse.length) {
    if(!$.fn.dataTable.isDataTable('#tbl-cn')) initTable('tbl-cn',[],[{title:'No data',data:null}],[],10);
    else { const dt=$('#tbl-cn').DataTable(); dt.clear().draw(); }
    return;
  }

  // Filter out rows where Svc column has *** or host_ind as ***
  const filteredRows = dataToUse.filter(row => {
    const svc = String(row['Svc'] || '').trim();
    const hostInd = String(row['host_ind'] || '').trim();
    return svc !== '***' && hostInd !== '***';
  });

  // Create columns with OD pill
  const cols = Object.keys(dataToUse[0] || {}).map(k => {
    if(k.toLowerCase() === 'od') {
      return {
        title: k,
        data: k,
        render: (data) => {
          const val = String(data || '').trim();
          const safe = htmlEsc(val);
          const bg = pillColor(val);
          return `<span class="od-pill px-2 py-1 rounded-full text-white text-xs font-medium"
                     style="background-color:${bg}"
                     onclick="filterAllTablesByOD('${safe}')">${safe}</span>`;
        }
      };
    }
    return {title:k,data:k};
  });

  initTable('tbl-cn', filteredRows, cols, [], 10);
}

/* ---------- update MSFVA table ---------- */
function updateMSFVATable() {
  let dataToUse = filteredMSFVAData.length > 0 ? filteredMSFVAData : [];
  
  if(!dataToUse.length) {
    if(!$.fn.dataTable.isDataTable('#tbl-ms')) initTable('tbl-ms',[],[{title:'No data',data:null}],[],10);
    else { const dt=$('#tbl-ms').DataTable(); dt.clear().draw(); }
    return;
  }

  const cols = Object.keys(dataToUse[0] || {}).map(k => {
    if(k.toLowerCase() === 'od') {
      return {
        title: k,
        data: k,
        render: (data) => {
          const val = String(data || '').trim();
          const safe = htmlEsc(val);
          const bg = pillColor(val);
          return `<span class="od-pill px-2 py-1 rounded-full text-white text-xs font-medium"
                     style="background-color:${bg}"
                     onclick="filterAllTablesByOD('${safe}')">${safe}</span>`;
        }
      };
    }
    return {title:k,data:k};
  });

  initTable('tbl-ms', dataToUse, cols, [], 10);
}

/* ---------- tab switching ---------- */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b=>{
      b.classList.remove('bg-blue-600','text-white','active');
      b.classList.add('text-zinc-300');
    });
    btn.classList.add('bg-blue-600','text-white','active');
    document.getElementById('tab-'+btn.dataset.tab).classList.remove('hidden');
    
    // Update the table based on current filter state
    if(btn.dataset.tab === 'fl') {
      updateFlowFVATable();
    } else if(btn.dataset.tab === 'ms') {
      updateMSFVATable();
    } else if(btn.dataset.tab === 'cn') {
      updateConnectionsFVATable();
    }
  });
});

// Set first tab as active by default
document.querySelector('button[data-tab="fl"]').classList.add('bg-blue-600','text-white','active');

/* ---------- file listeners ---------- */
document.getElementById('file1').addEventListener('change',e=>loadFirstTable(e.target.files[0]));
document.getElementById('file2').addEventListener('change',e=>loadSecondTable(e.target.files[0],'MSFVA'));
document.getElementById('file3').addEventListener('change',e=>loadSecondTable(e.target.files[0],'FlowFVA'));
document.getElementById('file4').addEventListener('change',e=>loadSecondTable(e.target.files[0],'ConnectionsFVA'));

// File upload area click handlers
document.getElementById('upload-kpi').addEventListener('click', () => document.getElementById('file1').click());
document.getElementById('upload-ms').addEventListener('click', () => document.getElementById('file2').click());
document.getElementById('upload-fl').addEventListener('click', () => document.getElementById('file3').click());
document.getElementById('upload-cn').addEventListener('click', () => document.getElementById('file4').click());

// Drag and drop functionality
['upload-kpi', 'upload-ms', 'upload-fl', 'upload-cn'].forEach(id => {
  const uploadArea = document.getElementById(id);
  const fileInput = document.getElementById(id.replace('upload-', 'file'));
  
  ['dragenter', 'dragover'].forEach(eventName => {
    uploadArea.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.add('drag-over');
    });
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('drag-over');
    });
  });
  
  uploadArea.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length) {
      fileInput.files = files;
      const event = new Event('change', { bubbles: true });
      fileInput.dispatchEvent(event);
    }
  });
});

// Back button for third table
document.getElementById('back-to-secondary').addEventListener('click', () => {
  document.getElementById('third-table-container').classList.add('hidden');
});

// Host filter functionality
document.getElementById('apply-host-filter').addEventListener('click', () => {
  currentHostFilter = document.getElementById('host-filter-input').value.trim();
  updateFlowFVATable();
});

// Top 10 drawer toggle
document.getElementById('top10-trigger').addEventListener('click', () => {
  const drawer = document.getElementById('top10-fixed');
  drawer.classList.toggle('open');
});

document.getElementById('top10-close').addEventListener('click', (e) => {
  e.stopPropagation();
  document.getElementById('top10-fixed').classList.remove('open');
});

// Detail drawer toggle
document.getElementById('detail-trigger').addEventListener('click', () => {
  const drawer = document.getElementById('detail-fixed');
  drawer.classList.toggle('open');
});

document.getElementById('detail-close').addEventListener('click', (e) => {
  e.stopPropagation();
  document.getElementById('detail-fixed').classList.remove('open');
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // 'F' key to toggle right drawer
  if (e.key === 'f' || e.key === 'F') {
    document.getElementById('top10-fixed').classList.toggle('open');
  }
  // 'D' key to toggle bottom drawer
  if (e.key === 'd' || e.key === 'D') {
    document.getElementById('detail-fixed').classList.toggle('open');
  }
});

// Initialize with first tab active
document.getElementById('tab-fl').classList.remove('hidden');

// Open drawers by default
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('top10-fixed').classList.add('open');
  document.getElementById('detail-fixed').classList.add('open');
});
</script>
</body>
</html>